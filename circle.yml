version: 1
machine:
  services:
     - postgresql
  python:
    version: 3.6.2
  environment:
    ENVIROMENT: staging
    #DATABASE_URL: postgresql://ubuntu:@127.0.0.1:5432/circle_test

#database:
#  override:
#"    - psql -c "ALTER USER postgres WITH CREATEDB" -U postgres

test:
  override:
    - make tests

dependencies:
  override:            
      - make setup

deployment: 
  staging:
    branch: 'XPTO'
    commands:      
      - |
        cat >~/.netrc <<EOF
        machine api.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        machine git.heroku.com
          login $HEROKU_EMAIL
          password $HEROKU_TOKEN
        EOF          
      - chmod 600 ~/.netrc # Heroku cli complains about permissions without this
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push git@heroku.com:aqueous-scrubland-68580.git $CIRCLE_SHA1:refs/heads/master